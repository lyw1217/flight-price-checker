# 항공권 최저가 조회 봇

텔레그램 봇을 통해 항공권 최저가를 주기적으로 조회하고 가격 하락 등 다양한 조건에 따라 알림을 보내주는 서비스입니다.

## 주요 기능

- 30분마다 항공권 가격 자동 조회 및 모니터링
- 가격 하락, 목표가 도달, 변동 등 다양한 조건에 따른 텔레그램 알림
- 시간대(예: 오전1, 오후2 등) 또는 시각(예: 9시 이전/15시 이후) 기반 항공편 필터링
- 사용자별 다중 모니터링 지원 (기본 3개, 환경변수로 조정 가능)
- 알림 주기(분 단위) 및 조건 사용자별 설정
- 관리자 기능: 전체 현황 조회, 전체 모니터링 일괄 취소
- 공항 코드 자동 로드 및 검증
- 데이터/설정/로그 자동 보관 및 정리

## 설치 방법

1. Python 3.8 이상 설치
2. 필요한 패키지 설치:
   ```bash
   pip install -r requirements.txt
   ```

## 환경 변수 설정

필수 환경변수:
- `BOT_TOKEN`: Telegram 봇 토큰
- `SELENIUM_HUB_URL`: Selenium Grid 주소 (예: http://localhost:4444/wd/hub)
- `ADMIN_IDS`: 관리자 ID 목록 (쉼표로 구분, 예: 12345678,98765432)

선택 환경변수:
- `USER_AGENT`: Selenium 브라우저 User-Agent (기본값 제공)
- `MAX_MONITORS`: 사용자당 최대 모니터링 개수 (기본: 3)
- `MAX_WORKERS`: Selenium 동시 실행 브라우저 수 (기본: 5)
- `FILE_WORKERS`: 파일 I/O 동시 작업자 수 (기본: 5)
- `DATA_RETENTION_DAYS`: 모니터링 데이터 보관 기간 (일, 기본: 30)
- `CONFIG_RETENTION_DAYS`: 사용자 설정 파일 보관 기간 (일, 기본: 7)
- `LOG_LEVEL`: 로그 레벨 (DEBUG, INFO, WARNING, ERROR, CRITICAL, 기본: INFO)

`.env.example` 파일 참고

## 실행 방법

```bash
python flight_checker.py
```

## 봇 명령어

**기본 명령어:**
- `/monitor`   : 새로운 모니터링 시작
- `/status`    : 내 모니터링 현황 확인
- `/cancel`    : 모니터링 취소
- `/settings`  : 시간/알림 조건 등 설정 확인 및 안내
- `/set`       : 시간/알림 조건/주기 직접 변경 (예: `/set 가는편 시간대 오전1 오전2`)
- `/airport`   : 주요 공항 코드 목록 안내
- `/help`      : 도움말

**관리자 명령어:**
- `/allstatus` : 전체 사용자 모니터링 현황
- `/allcancel` : 전체 모니터링 일괄 취소

## 주요 설정 예시

- 시간대 설정: `/set 가는편 시간대 오전1 오전2`  (가는 편 오전1, 오전2 시간대만 검색)
- 시각 설정: `/set 오는편 시각 15`  (오는 편 15시 이후 출발만 검색)
- 알림 조건:
  - `/set 알림조건 기본` (5000원 이상 하락 시)
  - `/set 알림조건 하락시` (1원이라도 하락 시)
  - `/set 알림조건 변동시` (상승/하락 모두 알림)
  - `/set 알림조건 목표가 150000` (15만원 이하 도달 시)
  - `/set 알림조건 역대최저가` (모니터링 시작 후 최저가 갱신 시)
  - `/set 알림조건 하락기준 3000` (3000원 이상 하락 시)
- 알림 주기: `/set 알림주기 15` (15분마다 알림)

## 데이터 저장 및 관리

- 모니터링 데이터: `/data/price_*.json` (각 모니터링별 개별 파일, 자동 생성/정리)
- 사용자 설정: `/data/user_configs/config_*.json` (각 사용자별 설정, 자동 생성/정리)
- 로그 파일: `/data/logs/flight_bot.log` (실행/오류/상태 로그, 자동 생성/정리)
- 공항 데이터: `data/airports.json` (공항 정보, 필요시 직접 편집)

> `/data` 폴더 하위에 모든 데이터가 저장되며, 공항 데이터(`airports.json`)만 `data/airports.json`(루트 기준)에 위치합니다.
> 모든 폴더/파일은 프로그램 실행 시 자동 생성되며,
> 오래된 데이터/설정/로그는 환경변수(`DATA_RETENTION_DAYS`, `CONFIG_RETENTION_DAYS`)에 따라 자동 삭제됩니다.

### 공항 데이터 관리

공항 정보는 `data/airports.json` 파일에서 관리합니다. 필요시 직접 편집하여 공항 정보를 추가/수정할 수 있습니다.

## 테스트

테스트는 unittest 기반으로 작성되어 있으며, 기능별로 체계적으로 분리되어 있습니다.

### 테스트 실행 방법

**전체 테스트 실행:**
```bash
# pytest 사용 (권장)
python -m pytest tests/ -v

# unittest 사용
python -m unittest discover tests
```

**개별 모듈 테스트:**
```bash
# 검증 기능 테스트
python -m pytest tests/test_validation.py -v

# 시간 제한 테스트
python -m pytest tests/test_time_restrictions.py -v

# 설정 관리 테스트
python -m pytest tests/test_config_manager.py -v
```

### 테스트 구조

테스트는 기능별로 다음과 같이 분리되어 있습니다:

#### 📁 tests/
- **`test_base.py`** - 공통 테스트 베이스 클래스 및 설정
- **`test_validation.py`** - 검증 기능 (3개 테스트)
  - 공항 코드 유효성 검사
  - URL 유효성 검증
  - 날짜 유효성 검사
- **`test_parsing.py`** - 파싱 기능 (1개 테스트)
  - 항공편 정보 파싱
- **`test_utils.py`** - 유틸리티 함수 (2개 테스트)
  - 시간 설정 문자열 포맷팅
  - 시간 범위 반환
- **`test_time_restrictions.py`** - 시간 제한 로직 (5개 테스트)
  - 기본 시간 제한 체크
  - 시간대별 제한 종합 테스트
  - 정확한 시각 제한 종합 테스트
  - 엣지 케이스 처리
  - 실제 시나리오 테스트
- **`test_message_manager.py`** - 메시지 관리 (5개 테스트)
  - 메시지 상태 관리
  - 메시지 업데이트 시나리오들
- **`test_config_manager.py`** - 설정 관리 (6개 테스트)
  - 사용자 설정 로드/저장
  - 다양한 시간 설정 타입 처리
  - 설정 영속성 및 기본값 처리
- **`test_suite.py`** - 통합 테스트 스위트
- **`test_flight_checker.py`** - 하위 호환성 래퍼

### 테스트 범위 (총 45개 테스트)
- ✅ URL 유효성 검증
- ✅ 항공편 정보 파싱
- ✅ 시간 제한 조건 체크 (시간대/시각 기반)
- ✅ 날짜 유효성 검사
- ✅ 공항 코드 유효성 검사
- ✅ 사용자 설정(config) 로드 및 저장
- ✅ 시간 설정 문자열 포맷팅/시간 범위 반환
- ✅ 메시지 매니저(MessageManager) 기능
- ✅ 설정 관리자(ConfigManager) 통합 기능
- ✅ 엣지 케이스 및 실제 시나리오 검증

### 테스트 아키텍처 특징
- **모듈화**: 기능별로 독립적인 테스트 파일 분리
- **재사용성**: `BaseTestCase` 클래스를 통한 공통 설정 중앙화
- **확장성**: 새로운 기능 추가 시 적절한 모듈에 쉽게 테스트 추가 가능
- **하위 호환성**: 기존 테스트 실행 방식 유지
- **통합 테스트**: 개별 모듈과 통합 스위트로 이중 검증

## 주의사항

- Selenium Grid가 반드시 실행 중이어야 하며, SELENIUM_HUB_URL이 올바르게 설정되어야 합니다.
- 데이터/설정 파일은 자동으로 주기적 정리됩니다.
- 시간대 구분: 새벽(00-06), 오전1(06-09), 오전2(09-12), 오후1(12-15), 오후2(15-18), 밤1(18-21), 밤2(21-24)
- 시각 설정: 가는 편은 설정 시각 이전, 오는 편은 설정 시각 이후 항공편 검색
- 알림 대상 설정:
  - **시간제한만**: 설정한 시간 조건(시간대/시각)에 맞는 항공편의 최저가만 모니터링하여 알림
  - **전체만**: 모든 시간의 항공편 중 최저가만 모니터링하여 알림    - **둘다**: 시간 제한 적용 최저가와 전체 최저가 모두 모니터링하여 각각 알림
  - 기본값은 '시간제한만'이며, 전체 최저가는 설정과 관계없이 항상 업데이트됨

## 개발 히스토리

### v2.0 - 테스트 코드 구조 개선 (2024.06.04)
- **대규모 테스트 코드 리팩토링 완료**
  - 단일 파일(680줄)에서 기능별 8개 모듈로 분리
  - 총 45개 테스트가 체계적으로 분류 및 관리
  - `BaseTestCase` 클래스를 통한 공통 설정 중앙화

- **새로운 테스트 구조:**
  - `test_validation.py`: 검증 기능 (공항, URL, 날짜)
  - `test_parsing.py`: 파싱 기능 
  - `test_utils.py`: 유틸리티 함수
  - `test_time_restrictions.py`: 시간 제한 로직
  - `test_message_manager.py`: 메시지 관리
  - `test_config_manager.py`: 설정 관리
  - `test_suite.py`: 통합 테스트 스위트
  - `test_base.py`: 공통 베이스 클래스

- **개선 효과:**
  - 가독성 향상: 기능별 명확한 분리
  - 유지보수성 증대: 독립적인 모듈 관리
  - 확장성 개선: 새 기능 테스트 추가 용이
  - 하위 호환성 유지: 기존 테스트 실행 방식 지원

## 라이선스

MIT License
